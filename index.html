<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω - –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px 10px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        /* –¢–∞–π–º–µ—Ä –∏ —Å—Ç–∞—Ç—É—Å */
        .status-timer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status-timer.active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .status-timer.inactive {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .status-timer.scheduled {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        
        .timer-title {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.95;
        }
        
        .timer-countdown {
            font-size: 28px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }
        
        .timer-details {
            font-size: 13px;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        .personal-view .status-timer {
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .personal-view .timer-title {
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .personal-view .timer-countdown {
            font-size: 18px;
        }
        
        .personal-view .timer-details {
            font-size: 11px;
            margin-top: 5px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }
        
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .day-section {
            background: white;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
        }
        
        .schedule-table th,
        .schedule-table td {
            border: 1px solid #e0e0e0;
            text-align: center;
            padding: 2px;
            height: 35px;
            overflow: hidden;
        }
        
        .schedule-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .schedule-table th.name-column {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            text-align: left;
            padding-left: 10px;
            background: #f0f0f0;
        }
        
        .schedule-table th.hours-column {
            width: 50px;
            background: #f0f0f0;
        }
        
        .schedule-table td.name-cell {
            text-align: left;
            padding-left: 10px;
            font-weight: 500;
            background: #fafafa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .schedule-table td.name-cell:hover {
            background: #e8f4fd;
        }
        
        .schedule-table td.hours-cell {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c5282;
        }
        
        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .schedule-table tr.current-user td {
            background: #fffbf0 !important;
            border-top: 2px solid #ffa000;
            border-bottom: 2px solid #ffa000;
        }
        
        .schedule-table tr.current-user td:first-child {
            border-left: 2px solid #ffa000;
        }
        
        .schedule-table tr.current-user td:last-child {
            border-right: 2px solid #ffa000;
        }
        
        .schedule-table tr.current-user td.name-cell {
            background: #fff3cd !important;
            font-weight: bold;
        }
        
        .slot-button {
            width: 100%;
            height: 30px;
            min-height: 30px;
            max-height: 30px;
            border: none;
            background: #fff;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
            padding: 2px;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .slot-button:hover:not(:disabled) {
            background: #e3f2fd;
        }
        
        .slot-button.booked {
            background: #4caf50;
            color: white;
        }
        
        .slot-button.booked:hover {
            background: #45a049;
        }
        
        .slot-button:disabled {
            background: #ffebee;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
        .personal-table-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .personal-schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: fixed;
        }
        
        .personal-schedule-table th,
        .personal-schedule-table td {
            border: 1px solid #e0e0e0;
            text-align: center;
            padding: 2px;
            height: 32px;
        }
        
        .personal-schedule-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 9px;
        }
        
        .personal-schedule-table th.day-column {
            width: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: left;
            padding-left: 8px;
        }
        
        .personal-schedule-table td.day-name {
            background: #f0f0f0;
            font-weight: 600;
            text-align: left;
            padding-left: 8px;
            font-size: 11px;
        }
        
        .personal-schedule-table .slot-button {
            height: 25px;
            min-height: 25px;
            font-size: 8px;
        }
        
        .personal-schedule-table td.hours-cell {
            background: #e3f2fd;
            font-weight: bold;
            color: #1976d2;
            font-size: 11px;
        }
        
        .personal-schedule-table .summary-row td {
            background: #fff3e0;
            padding: 3px 1px;
            font-size: 9px;
        }
        
        .personal-schedule-table .summary-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 1px;
        }
        
        .personal-schedule-table .summary-required {
            color: #f57c00;
            font-weight: bold;
            font-size: 9px;
        }
        
        .personal-schedule-table .summary-current {
            color: #388e3c;
            font-size: 8px;
        }
        
        .total-hours {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        .summary-row {
            background: #fff3e0 !important;
            font-weight: bold;
        }
        
        .summary-row td {
            background: #fff3e0;
            padding: 5px 2px;
            font-size: 11px;
        }
        
        .summary-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }
        
        .summary-required {
            color: #f57c00;
            font-weight: bold;
        }
        
        .summary-current {
            color: #388e3c;
            font-size: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .employee-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #fffbf0;
            border: 2px solid #ffa000;
            border-radius: 8px;
        }
        
        .employee-selector select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .employee-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .schedule-table {
                font-size: 10px;
            }
            
            .schedule-table th.name-column {
                width: 100px;
                min-width: 100px;
            }
            
            .slot-button {
                font-size: 9px;
            }
            
            .timer-countdown {
                font-size: 22px;
            }
            
            .personal-schedule-table {
                font-size: 8px;
            }
            
            .personal-schedule-table th {
                font-size: 7px;
                padding: 1px;
            }
            
            .personal-schedule-table .slot-button {
                font-size: 7px;
                height: 22px;
                min-height: 22px;
            }
            
            .personal-schedule-table th.day-column {
                width: 50px;
                font-size: 8px;
            }
            
            .personal-view .status-timer {
                padding: 8px;
            }
            
            .personal-view .timer-countdown {
                font-size: 14px;
            }
        }
        
        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-height: 500px) and (orientation: landscape) {
            .personal-view .status-timer {
                padding: 5px;
                margin-bottom: 10px;
            }
            
            .personal-view .timer-countdown {
                font-size: 14px;
            }
            
            .personal-schedule-table {
                font-size: 7px;
            }
            
            .personal-schedule-table th,
            .personal-schedule-table td {
                height: 22px;
            }
            
            .personal-schedule-table .slot-button {
                height: 20px;
                min-height: 20px;
                font-size: 6px;
            }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .toast.success {
            background: #4caf50;
        }
        
        .toast.error {
            background: #f44336;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- –¢–∞–π–º–µ—Ä –∏ —Å—Ç–∞—Ç—É—Å -->
    <div id="statusTimer" class="status-timer">
        <div class="timer-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="timer-countdown">--:--:--</div>
        <div class="timer-details"></div>
    </div>
    
    <div class="header" id="mainHeader">
        <h1>üìÖ –ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
        <div class="info">
            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —è—á–µ–π–∫—É, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–º–µ–Ω—É. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –æ—Ç–º–µ–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å.
        </div>
        
        <div class="employee-selector" id="employeeSelector">
            <label for="employeeSelect">üî¥ –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã:</label>
            <select id="employeeSelect" onchange="selectEmployee()">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
            </select>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box" style="background: white; border: 1px solid #ddd;"></div>
                <span>–°–≤–æ–±–æ–¥–Ω–æ</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #4caf50;"></div>
                <span>–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #ffebee;"></div>
                <span>–°–ª–æ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #fff3e0;"></div>
                <span>–ò—Ç–æ–≥–æ (—Ç—Ä–µ–±—É–µ—Ç—Å—è/–∑–∞–ø–∏—Å–∞–Ω–æ)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #fffbf0; border: 2px solid #ffa000;"></div>
                <span>–í–∞—à–∞ —Å—Ç—Ä–æ–∫–∞</span>
            </div>
        </div>
    </div>
    
    <div id="loading" class="loading">
        ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...
    </div>
    
    <div id="schedule-container"></div>

    <script>
        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase
        const SUPABASE_URL = 'https://gyraftcengparsbayrll.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_beR5cMb5U2NQUEwJ1Not2g_16xOcp1V';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentEmployeeId = null;
        let currentEmployeeName = null;
        let employees = [];
        let requirements = {};
        let bookings = {};
        let scheduleSettings = {};
        let isPersonalView = false;
        let personalEmployeeId = null;
        let timerInterval = null;
        let settingsCheckInterval = null;
        let weekStartDate = null;
        let scheduleOpen = false;
        
        const daysOfWeek = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
        const daysOfWeekShort = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
        
        document.addEventListener('DOMContentLoaded', () => {
            checkPersonalView();
            loadSettings();
            loadEmployees();
            startTimer();
            startSettingsCheck();
            
            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const subscription = supabaseClient
                .channel('schedule-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'schedule_bookings' },
                    () => loadSchedule()
                )
                .subscribe();
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ª–∏ —ç—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        function checkPersonalView() {
            const urlParams = new URLSearchParams(window.location.search);
            const employeeName = urlParams.get('employee');
            
            if (employeeName) {
                isPersonalView = true;
                document.body.classList.add('personal-view');
                
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏–º—è –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
                const decodedName = decodeURIComponent(employeeName).replace(/_/g, ' ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const header = document.getElementById('mainHeader');
                if (header) {
                    header.innerHTML = `
                        <h2 style="color: #667eea; margin-bottom: 10px;">üìÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</h2>
                        <h3 style="color: #333; margin-bottom: 15px;">${decodedName}</h3>
                        <div class="info" style="font-size: 13px;">
                            –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –æ—Ç–º–µ–Ω—è–µ—Ç –≤—ã–±–æ—Ä.
                        </div>
                    `;
                }
            }
        }
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function startSettingsCheck() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            settingsCheckInterval = setInterval(async () => {
                await loadSettings(true); // true = —Ç–∏—Ö–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            }, 10000);
        }
        
        // –¢–∞–π–º–µ—Ä
        function startTimer() {
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é –≤ –ë–î
            checkScheduleEditability();
            
            if (!scheduleSettings.schedule_open_from || !scheduleSettings.schedule_open_until) {
                return;
            }
            
            const now = new Date();
            const moscowNow = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Moscow"}));
            const openFrom = new Date(scheduleSettings.schedule_open_from);
            const openUntil = new Date(scheduleSettings.schedule_open_until);
            
            const timerEl = document.getElementById('statusTimer');
            const titleEl = timerEl.querySelector('.timer-title');
            const countdownEl = timerEl.querySelector('.timer-countdown');
            const detailsEl = timerEl.querySelector('.timer-details');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫—É is_schedule_active
            const isManuallyActive = scheduleSettings.is_schedule_active === 'true';
            
            if (!isManuallyActive) {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ –∞–¥–º–∏–Ω–∫–µ
                timerEl.className = 'status-timer inactive';
                titleEl.textContent = 'üîí –ì—Ä–∞—Ñ–∏–∫ –ó–ê–ö–†–´–¢ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
                countdownEl.textContent = '--:--:--';
                detailsEl.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                scheduleOpen = false;
                
            } else if (moscowNow < openFrom) {
                // –ì—Ä–∞—Ñ–∏–∫ –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—ã—Ç
                scheduleOpen = false;
                const msUntilOpen = openFrom - moscowNow;
                const countdown = formatCountdown(msUntilOpen);
                
                timerEl.className = 'status-timer scheduled';
                titleEl.textContent = '‚è∞ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑:';
                countdownEl.textContent = countdown;
                detailsEl.textContent = `–û—Ç–∫—Ä–æ–µ—Ç—Å—è ${openFrom.toLocaleString('ru-RU')}`;
                
            } else if (moscowNow >= openFrom && moscowNow <= openUntil) {
                // –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω
                scheduleOpen = true;
                const msLeft = openUntil - moscowNow;
                const countdown = formatCountdown(msLeft);
                
                timerEl.className = 'status-timer active';
                titleEl.textContent = '‚úÖ –ì—Ä–∞—Ñ–∏–∫ –û–¢–ö–†–´–¢ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                countdownEl.textContent = countdown;
                detailsEl.textContent = '–î–æ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Å—Ç–∞–ª–æ—Å—å';
                
            } else {
                // –ì—Ä–∞—Ñ–∏–∫ –∑–∞–∫—Ä—ã—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                scheduleOpen = false;
                timerEl.className = 'status-timer inactive';
                titleEl.textContent = 'üîí –ì—Ä–∞—Ñ–∏–∫ –ó–ê–ö–†–´–¢';
                countdownEl.textContent = '--:--:--';
                detailsEl.textContent = `–ü–µ—Ä–∏–æ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à—ë–Ω ${openUntil.toLocaleString('ru-RU')}`;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –ë–î
        async function checkScheduleEditability() {
            try {
                const { data, error } = await supabaseClient
                    .rpc('is_schedule_editable');
                
                if (!error && data !== undefined) {
                    const wasOpen = scheduleOpen;
                    scheduleOpen = data;
                    
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                    if (wasOpen !== scheduleOpen) {
                        loadSchedule();
                    }
                }
            } catch (error) {
                console.error('Error checking schedule editability:', error);
            }
        }
        
        function formatCountdown(ms) {
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (days > 0) {
                return `${days}–¥ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        async function loadSettings(silent = false) {
            try {
                const { data, error } = await supabaseClient
                    .from('system_settings')
                    .select('*');
                
                if (error) throw error;
                
                let settingsChanged = false;
                
                data.forEach(setting => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (scheduleSettings[setting.setting_key] !== setting.setting_value) {
                        settingsChanged = true;
                    }
                    scheduleSettings[setting.setting_key] = setting.setting_value;
                });
                
                // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                if (settingsChanged && !silent) {
                    updateTimer();
                }
                
                // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –≤—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                if (!silent) {
                    loadSchedule();
                }
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        async function loadEmployees() {
            const { data, error } = await supabaseClient
                .from('employees')
                .select('*')
                .eq('is_active', true)
                .order('sort_order', { ascending: true });
            
            if (error) {
                console.error('Error loading employees:', error);
                return;
            }
            
            employees = data;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –Ω–∞—Ö–æ–¥–∏–º ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if (isPersonalView) {
                const urlParams = new URLSearchParams(window.location.search);
                const employeeNameTranslit = urlParams.get('employee');
                
                // –ò—â–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏
                const employee = employees.find(emp => 
                    transliterate(emp.full_name) === employeeNameTranslit
                );
                
                if (employee) {
                    currentEmployeeId = employee.id;
                    currentEmployeeName = employee.full_name;
                    personalEmployeeId = employee.id;
                }
            } else {
                // –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
                const select = document.getElementById('employeeSelect');
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>' +
                    employees.map(emp => 
                        `<option value="${emp.id}">${emp.full_name}</option>`
                    ).join('');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±–æ—Ä –∏–∑ localStorage
                const savedId = localStorage.getItem('currentEmployeeId');
                if (savedId) {
                    select.value = savedId;
                    currentEmployeeId = parseInt(savedId);
                    const employee = employees.find(emp => emp.id === currentEmployeeId);
                    if (employee) {
                        currentEmployeeName = employee.full_name;
                    }
                }
            }
        }
        
        function selectEmployee() {
            const select = document.getElementById('employeeSelect');
            currentEmployeeId = select.value ? parseInt(select.value) : null;
            
            if (currentEmployeeId) {
                const employee = employees.find(emp => emp.id === currentEmployeeId);
                currentEmployeeName = employee ? employee.full_name : null;
                localStorage.setItem('currentEmployeeId', currentEmployeeId);
            } else {
                currentEmployeeName = null;
                localStorage.removeItem('currentEmployeeId');
            }
            
            loadSchedule();
        }
        
        async function loadSchedule() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('schedule-container');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const weekStartDay = parseInt(scheduleSettings.week_start_day || '1');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏
                let daysUntilStart;
                const currentDay = today.getDay();
                
                if (currentDay === weekStartDay) {
                    // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏, –Ω–∞—á–∏–Ω–∞–µ–º —Å —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏
                    daysUntilStart = 7;
                } else if (currentDay < weekStartDay) {
                    // –î–µ–Ω—å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
                    daysUntilStart = weekStartDay - currentDay;
                } else {
                    // –î–µ–Ω—å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏ —É–∂–µ –ø—Ä–æ—à—ë–ª, –±–µ—Ä—ë–º —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é
                    daysUntilStart = 7 - currentDay + weekStartDay;
                }
                
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + daysUntilStart);
                weekStartDate = new Date(weekStart); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
                const { data: reqData, error: reqError } = await supabaseClient
                    .from('slot_requirements')
                    .select('*')
                    .gte('date', weekStart.toISOString().split('T')[0])
                    .lte('date', weekEnd.toISOString().split('T')[0]);
                
                if (reqError) throw reqError;
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                requirements = {};
                reqData.forEach(req => {
                    const key = `${req.date}_${req.hour_slot}`;
                    requirements[key] = req.required_count;
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
                const { data: bookData, error: bookError } = await supabaseClient
                    .from('schedule_bookings')
                    .select('*')
                    .gte('date', weekStart.toISOString().split('T')[0])
                    .lte('date', weekEnd.toISOString().split('T')[0]);
                
                if (bookError) throw bookError;
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏
                bookings = {};
                bookData.forEach(book => {
                    const key = `${book.date}_${book.hour_slot}`;
                    if (!bookings[key]) bookings[key] = [];
                    bookings[key].push(book.employee_id);
                });
                
                loading.style.display = 'none';
                
                if (isPersonalView) {
                    container.innerHTML = generatePersonalScheduleHTML(weekStart);
                } else {
                    container.innerHTML = generateScheduleHTML(weekStart);
                }
                
            } catch (error) {
                loading.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
                console.error('Error:', error);
            }
        }
        
        function generateScheduleHTML(weekStart) {
            let html = '';
            
            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + day);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayName = daysOfWeek[currentDate.getDay()];
                const dateFormatted = currentDate.toLocaleDateString('ru-RU', { 
                    day: 'numeric', 
                    month: 'long' 
                });
                
                html += `
                    <div class="day-section">
                        <div class="day-header">
                            ${dayName}, ${dateFormatted}
                        </div>
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th class="name-column">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                    ${generateHourHeaders()}
                                    <th class="hours-column">–ß–∞—Å—ã</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateEmployeeRows(dateStr)}
                                ${generateSummaryRow(dateStr)}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            return html;
        }
        
        function generatePersonalScheduleHTML(weekStart) {
            let totalWeekHours = 0;
            
            let html = `
                <div class="personal-table-container">
                    <table class="personal-schedule-table">
                        <thead>
                            <tr>
                                <th class="day-column">–î–µ–Ω—å</th>
                                ${generateHourHeaders()}
                                <th style="background: #f0f0f0;">–ß–∞—Å—ã</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + day);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayName = daysOfWeekShort[currentDate.getDay()];
                const dateFormatted = currentDate.toLocaleDateString('ru-RU', { 
                    day: 'numeric', 
                    month: 'numeric' 
                });
                
                let dayHours = 0;
                
                html += `<tr>
                    <td class="day-name">${dayName} ${dateFormatted}</td>`;
                
                for (let hour = 0; hour < 24; hour++) {
                    const key = `${dateStr}_${hour}`;
                    const isBooked = bookings[key]?.includes(personalEmployeeId);
                    const required = requirements[key] || 0;
                    const current = bookings[key]?.length || 0;
                    const isFull = current >= required;
                    
                    if (isBooked) dayHours++;
                    
                    const start = hour.toString().padStart(2, '0');
                    
                    html += `
                        <td>
                            <button 
                                class="slot-button ${isBooked ? 'booked' : ''}"
                                onclick="toggleBooking(${personalEmployeeId}, '${dateStr}', ${hour})"
                                ${!isBooked && isFull ? 'disabled' : ''}>
                                ${start}
                                ${isBooked ? '‚úì' : ''}
                            </button>
                        </td>
                    `;
                }
                
                totalWeekHours += dayHours;
                html += `<td class="hours-cell">${dayHours}</td></tr>`;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏/–∑–∞–ø–∏—Å–∞–Ω–æ
            html += '<tr class="summary-row"><td style="background: #fff3e0; font-weight: bold;">–¢—Ä–µ–±./–ó–∞–ø.</td>';
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞ –Ω–µ–¥–µ–ª–∏
            for (let hour = 0; hour < 24; hour++) {
                let totalRequired = 0;
                let totalBooked = 0;
                
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(weekStart.getDate() + day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const key = `${dateStr}_${hour}`;
                    
                    totalRequired += requirements[key] || 0;
                    totalBooked += bookings[key]?.length || 0;
                }
                
                const percentage = totalRequired > 0 ? (totalBooked / totalRequired * 100) : 0;
                
                let bgColor = '#fff3e0';
                if (percentage >= 100) bgColor = '#c8e6c9';
                else if (percentage >= 70) bgColor = '#fff9c4';
                else if (percentage >= 40) bgColor = '#ffe0b2';
                else if (percentage > 0) bgColor = '#ffccbc';
                
                html += `
                    <td style="background: ${bgColor};">
                        <div class="summary-cell">
                            <span class="summary-required">${totalRequired}</span>
                            <span class="summary-current">${totalBooked}</span>
                        </div>
                    </td>
                `;
            }
            
            html += `<td style="background: #fff3e0;">-</td></tr>`;
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="total-hours">
                    üìä –í—Å–µ–≥–æ —á–∞—Å–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª–µ: ${totalWeekHours}
                </div>
            `;
            
            return html;
        }
        
        function generateHourHeaders() {
            let headers = '';
            for (let hour = 0; hour < 24; hour++) {
                const start = hour.toString().padStart(2, '0');
                const end = ((hour + 1) % 24).toString().padStart(2, '0');
                headers += `<th>${start}-${end}</th>`;
            }
            return headers;
        }
        
        function generateEmployeeRows(dateStr) {
            return employees.map(employee => {
                const isCurrentUser = employee.id === currentEmployeeId;
                let dayHours = 0;
                
                let row = `
                    <tr ${isCurrentUser ? 'class="current-user"' : ''}>
                        <td class="name-cell" onclick="openPersonalPage('${employee.full_name}')" 
                            title="–û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫">
                            ${employee.full_name}
                        </td>
                `;
                
                for (let hour = 0; hour < 24; hour++) {
                    const key = `${dateStr}_${hour}`;
                    const isBooked = bookings[key]?.includes(employee.id);
                    const required = requirements[key] || 0;
                    const current = bookings[key]?.length || 0;
                    const isFull = current >= required;
                    
                    if (isBooked) dayHours++;
                    
                    const start = hour.toString().padStart(2, '0');
                    const end = ((hour + 1) % 24).toString().padStart(2, '0');
                    
                    if (employee.id === currentEmployeeId) {
                        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∏–º–∞—Ç—å –Ω–∞ —Å–≤–æ–∏ –∫–Ω–æ–ø–∫–∏
                        row += `
                            <td>
                                <button 
                                    class="slot-button ${isBooked ? 'booked' : ''}"
                                    onclick="toggleBooking(${employee.id}, '${dateStr}', ${hour})"
                                    ${!isBooked && isFull ? 'disabled' : ''}>
                                    ${start}-${end}
                                    ${isBooked ? '‚úì' : ''}
                                </button>
                            </td>
                        `;
                    } else {
                        // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å
                        row += `
                            <td>
                                <div class="slot-button" style="cursor: default; ${isBooked ? 'background: #e8f5e9;' : ''}">
                                    ${start}-${end}
                                    ${isBooked ? '‚úì' : ''}
                                </div>
                            </td>
                        `;
                    }
                }
                
                row += `<td class="hours-cell">${dayHours}</td></tr>`;
                return row;
            }).join('');
        }
        
        function generateSummaryRow(dateStr) {
            let row = `
                <tr class="summary-row">
                    <td class="name-cell"><strong>–¢—Ä–µ–±—É–µ—Ç—Å—è / –ó–∞–ø–∏—Å–∞–Ω–æ</strong></td>
            `;
            
            for (let hour = 0; hour < 24; hour++) {
                const key = `${dateStr}_${hour}`;
                const required = requirements[key] || 0;
                const current = bookings[key]?.length || 0;
                const percentage = required > 0 ? (current / required * 100) : 0;
                
                let bgColor = '#fff3e0';
                if (percentage >= 100) bgColor = '#c8e6c9';
                else if (percentage >= 70) bgColor = '#fff9c4';
                else if (percentage >= 40) bgColor = '#ffe0b2';
                else if (percentage > 0) bgColor = '#ffccbc';
                
                row += `
                    <td style="background: ${bgColor};">
                        <div class="summary-cell">
                            <span class="summary-required">${required}</span>
                            <span class="summary-current">${current}</span>
                        </div>
                    </td>
                `;
            }
            
            row += '<td class="hours-cell">-</td></tr>';
            return row;
        }
        
        // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –¥–ª—è URL
        function transliterate(str) {
            const ru = {
                '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd',
                '–µ': 'e', '—ë': 'yo', '–∂': 'zh', '–∑': 'z', '–∏': 'i',
                '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n',
                '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't',
                '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch',
                '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '',
                '—ç': 'e', '—é': 'yu', '—è': 'ya',
                '–ê': 'A', '–ë': 'B', '–í': 'V', '–ì': 'G', '–î': 'D',
                '–ï': 'E', '–Å': 'Yo', '–ñ': 'Zh', '–ó': 'Z', '–ò': 'I',
                '–ô': 'Y', '–ö': 'K', '–õ': 'L', '–ú': 'M', '–ù': 'N',
                '–û': 'O', '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T',
                '–£': 'U', '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch',
                '–®': 'Sh', '–©': 'Sch', '–™': '', '–´': 'Y', '–¨': '',
                '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
            };
            
            return str.split('').map(char => ru[char] || char).join('')
                .replace(/\s+/g, '_')
                .replace(/[^a-zA-Z0-9_]/g, '');
        }
        
        function openPersonalPage(employeeName) {
            const transliteratedName = transliterate(employeeName);
            const url = `${window.location.origin}${window.location.pathname}?employee=${transliteratedName}`;
            window.open(url, '_blank');
        }
        
        async function toggleBooking(employeeId, date, hourSlot) {
            if (!isPersonalView && !currentEmployeeId) {
                showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è –∏–∑ —Å–ø–∏—Å–∫–∞!', 'error');
                return;
            }
            
            if (!isPersonalView && employeeId !== currentEmployeeId) {
                showToast('–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏!', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.rpc('toggle_booking', {
                    p_employee_id: employeeId,
                    p_date: date,
                    p_hour_slot: hourSlot
                });
                
                if (error) throw error;
                
                if (data.success) {
                    if (data.action === 'booked') {
                        showToast('‚úÖ –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ —Å–º–µ–Ω—É!', 'success');
                    } else if (data.action === 'cancelled') {
                        showToast('‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
                    }
                    await loadSchedule();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }
        
        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            if (settingsCheckInterval) {
                clearInterval(settingsCheckInterval);
            }
        });
    </script>
</body>
</html>
